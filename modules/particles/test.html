<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Particles Module Test</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #0a0a0a;
      font-family: system-ui, -apple-system, sans-serif;
    }

    #canvas {
      display: block;
    }

    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 8px;
      color: white;
    }

    button {
      display: block;
      width: 200px;
      margin: 10px 0;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    button:hover {
      transform: scale(1.05);
    }

    button:active {
      transform: scale(0.98);
    }

    #burst1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #burst2 {
      background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
      color: white;
    }

    #confetti {
      background: linear-gradient(135deg, #f6ad55 0%, #ed64a6 100%);
      color: white;
    }

    #ambient {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
    }

    #clear {
      background: #2d3748;
      color: white;
    }

    #stats {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 12px;
      line-height: 1.6;
    }

    .stat-label {
      color: #999;
    }

    h2 {
      margin: 0 0 15px 0;
      font-size: 18px;
      font-weight: 700;
    }

    .section {
      margin-bottom: 20px;
    }

    .instructions {
      font-size: 11px;
      color: #999;
      margin-top: 10px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <h2>Particle System Test</h2>

    <div class="section">
      <button id="burst1">Hit Burst (Player 1)</button>
      <button id="burst2">Hit Burst (Player 2)</button>
      <button id="confetti">Victory Confetti</button>
      <button id="ambient">Toggle Ambient</button>
      <button id="clear">Clear All</button>
    </div>

    <div id="stats">
      <div><span class="stat-label">Active Particles:</span> <span id="count">0</span></div>
      <div><span class="stat-label">FPS:</span> <span id="fps">0</span></div>
      <div><span class="stat-label">Status:</span> <span id="status">Ready</span></div>
    </div>

    <div class="instructions">
      <strong>Test Instructions:</strong><br>
      • Click buttons to create particle effects<br>
      • Watch particles fall with gravity<br>
      • Ambient particles float continuously<br>
      • Drag to rotate camera view
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js'
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js'
    import { init, update, clearAll, getParticleCount } from './system.js'
    import { createHitBurst, createConfetti, createAmbientParticles } from './effects.js'

    // Mock event bus for testing
    const listeners = {}
    window.mockEvents = {
      emit: (event, data) => {
        console.log('Event emitted:', event, data)
        document.getElementById('status').textContent = event
      },
      on: (event, callback) => {
        if (!listeners[event]) listeners[event] = []
        listeners[event].push(callback)
      }
    }

    // Mock state for testing
    window.mockState = {
      get: (key) => {
        if (key === 'player1Palette') return 'royal'
        if (key === 'player2Palette') return 'royal'
        return null
      },
      subscribe: () => {}
    }

    // Set up Three.js scene
    const scene = new THREE.Scene()
    scene.background = new THREE.Color(0x0a0a0a)

    // Camera
    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    )
    camera.position.set(0, 0, 15)

    // Renderer
    const canvas = document.getElementById('canvas')
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true })
    renderer.setSize(window.innerWidth, window.innerHeight)
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))

    // Orbit controls
    const controls = new OrbitControls(camera, canvas)
    controls.enableDamping = true
    controls.dampingFactor = 0.05

    // Add some reference geometry (timer positions)
    const timer1Geometry = new THREE.BoxGeometry(2, 0.5, 0.5)
    const timer1Material = new THREE.MeshBasicMaterial({
      color: 0x667eea,
      transparent: true,
      opacity: 0.3
    })
    const timer1 = new THREE.Mesh(timer1Geometry, timer1Material)
    timer1.position.set(0, -3, 0)
    scene.add(timer1)

    const timer2 = timer1.clone()
    timer2.position.set(0, 3, 0)
    scene.add(timer2)

    // Add grid helper
    const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222)
    scene.add(gridHelper)

    // Add axis helper
    const axesHelper = new THREE.AxesHelper(5)
    scene.add(axesHelper)

    // Initialize particle system
    init(scene)

    // Test buttons
    let ambientActive = false

    document.getElementById('burst1').onclick = () => {
      createHitBurst(
        { x: 0, y: -3, z: 0 },
        { r: 0.4, g: 0.49, b: 0.92 },
        window.testParticles,
        window.testGetIndex
      )
    }

    document.getElementById('burst2').onclick = () => {
      createHitBurst(
        { x: 0, y: 3, z: 0 },
        { r: 0.96, g: 0.4, b: 0.35 },
        window.testParticles,
        window.testGetIndex
      )
    }

    document.getElementById('confetti').onclick = () => {
      // Alternate between player 1 and 2
      const winner = Math.random() > 0.5 ? 1 : 2
      createConfetti(winner, window.testParticles, window.testGetIndex)
    }

    document.getElementById('ambient').onclick = () => {
      if (ambientActive) {
        clearAll()
        ambientActive = false
      } else {
        createAmbientParticles(window.testParticles, window.testGetIndex)
        ambientActive = true
      }
    }

    document.getElementById('clear').onclick = () => {
      clearAll()
      ambientActive = false
    }

    // FPS counter
    let frameCount = 0
    let lastTime = performance.now()

    function updateStats() {
      frameCount++
      const now = performance.now()
      const elapsed = now - lastTime

      if (elapsed >= 1000) {
        const fps = Math.round((frameCount * 1000) / elapsed)
        document.getElementById('fps').textContent = fps
        frameCount = 0
        lastTime = now
      }

      document.getElementById('count').textContent = getParticleCount()
    }

    // Animation loop
    const clock = new THREE.Clock()

    function animate() {
      requestAnimationFrame(animate)

      const deltaTime = clock.getDelta()

      // Update particles
      update(deltaTime)

      // Update controls
      controls.update()

      // Render scene
      renderer.render(scene, camera)

      // Update stats
      updateStats()
    }

    // Handle window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight
      camera.updateProjectionMatrix()
      renderer.setSize(window.innerWidth, window.innerHeight)
    })

    // Start animation
    animate()

    console.log('[Test] Particle system initialized')
    console.log('[Test] Click buttons to test effects')
  </script>
</body>
</html>
